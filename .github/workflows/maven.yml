name: Java CI with Maven

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - run: mvn -B compile -DskipTests=true --file pom.xml

  test-linux:
    runs-on: ubuntu-latest
    strategy: 
      matrix:
        java: [8, 11, 13]
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: ${{ matrix.java }}
        java-package: jdk
    - run: sudo /usr/bin/Xvfb $DISPLAY -screen 0 1024x768x24 &
    - run: |
        if [ "`R --version | head -1 | cut -d' ' -f3 | cut -d. -f1`" -ne "3" ]; then \
          sudo apt purge r-base r-recommended; \
          CODENAME=`cat /etc/lsb-release | grep CODENAME | cut -d= -f2`; \
          echo "deb https://cloud.r-project.org/bin/linux/ubuntu "$CODENAME"-cran35/" | sudo tee -a /etc/apt/sources.list; \
          sudo apt-get update -qq --allow-unauthenticated; \
          sudo apt-get install r-base --allow-unauthenticated -y; \
        fi
    - run: mvn -B test --file pom.xml
      
  test-macos:
    runs-on: macos-latest
    strategy: 
      matrix:
        java: [8, 11, 13]
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: ${{ matrix.java }}
        java-package: jdk
    - run: |
        if [ "`R --version | head -1 | cut -d' ' -f3 | cut -d. -f1`" -ne "3" ]; then \
          export HOMEBREW_NO_AUTO_UPDATE=1; \
          wd=$PWD; \
          cd /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core; git reset --hard c3a244c627e; git checkout -b r-3.6.3; \
          cd $wd; \
          brew install r; \
        fi
    - run: mvn -B test --file pom.xml
            
  test-windows:
    runs-on: windows-latest
    env: 
      shell: bash
    strategy: 
      matrix:
        java: [8, 11, 13]
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: ${{ matrix.java }}
        java-package: jdk
    - run: sudo /usr/bin/Xvfb $DISPLAY -screen 0 1024x768x24 &
    - run: |
        if [ "`R --version | head -1 | cut -d' ' -f3 | cut -d. -f1`" -ne "3" ]; then \
          choco install -y r --version 3.6; \
        fi
    - run: mvn -B test --file pom.xml

  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - run: mvn -B package -DskipTests=true --file pom.xml
    - run: mkdir -p dist && cp target/rsession.jar dist/.
      if: ${{ github.ref == 'refs/heads/master' }}
    - uses: actions/upload-artifact@v2
      with:
        name: Release
        path: dist
    
    
