# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - run: mvn -B compile -DskipTests=true --file pom.xml

  test-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - run: |
        sudo apt-get install xvfb --allow-unauthenticated -y
        export DISPLAY=:99.0
        sudo /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1024x768x24
        sleep 3
    - run: |
        if [ "`R --version | head -1 | cut -d' ' -f3 | cut -d. -f1`" -ne "3" ]; then
          CODENAME=`cat /etc/lsb-release | grep CODENAME| cut -d= -f2`
          echo "deb https://cloud.r-project.org/bin/linux/ubuntu "$CODENAME"-cran35/" | sudo tee -a /etc/apt/sources.list
        fi
        sudo apt-get update -qq --allow-unauthenticated
        sudo apt-get install r-base --allow-unauthenticated -y
    - run: mvn -B test --file pom.xml
      
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - run: mkdir -p dist && cp target/rsession.jar dist
      if: ${{ github.ref == 'refs/heads/master' }}
    - uses: actions/upload-artifact@v2
      with:
        name: Release
        path: dist
    - run: mvn -B package -DskipTests=true --file pom.xml
    
    
